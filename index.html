<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RYNO Campaign Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .campaign-item, .account-item { border: 1px solid #9ca3af; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 2rem; background-color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .input-group { border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1.5rem; background-color: #f8fafc; }
        .input-group h3, .input-group h4 { border-bottom: 1px solid #e2e8f0; padding-bottom: 0.75rem; margin-bottom: 1rem; }
        /* RYNO Branding Colors */
        .btn-primary { background-color: #345177; color: white; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.375rem; transition: background-color 0.3s; }
        .btn-primary:hover { background-color: #2c4362; }
        .btn-secondary { background-color: #e2e8f0; color: #475569; font-weight: 500; padding: 0.5rem 1rem; border-radius: 0.375rem; transition: background-color 0.3s; }
        .btn-secondary:hover { background-color: #cbd5e1; }
        .btn-accent { background-color: #f39c12; color: white; }
        .btn-accent:hover { background-color: #e67e22; }
        .form-input, .form-textarea, .form-select { width: 100%; border: 1px solid #cbd5e1; border-radius: 0.375rem; padding: 0.5rem 0.75rem; transition: border-color 0.3s, box-shadow 0.3s; }
        .form-input:focus, .form-textarea:focus, .form-select:focus { outline: none; border-color: #345177; box-shadow: 0 0 0 2px rgba(52, 81, 119, 0.2); }
        .ad-group-item, .extension-item { border-top: 1px dashed #cbd5e1; padding-top: 1rem; margin-top: 1rem; }
        .ad-group-item:first-child, .extension-item:first-child { border-top: none; padding-top: 0; margin-top: 0; }
        .remove-btn { color: #ef4444; font-weight: bold; cursor: pointer; }
        .remove-btn:hover { color: #b91c1c; }
        .campaign-header { cursor: pointer; }
        .campaign-content.hidden { display: none; }
        .char-limit-error { color: #ef4444; font-weight: bold; }
        .live-preview {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: monospace;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            margin-top: 0.5rem;
            min-height: 40px;
        }
        summary { cursor: pointer; }
        /* Custom modal for alerts */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); text-align: center; max-width: 90%; width: 400px; }
        .modal-close-btn { margin-top: 1rem; }
        /* Image Drop Zone Styles */
        .drop-zone--over {
            border-color: #345177;
            background-color: #f0f4f8;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-6xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">RYNO Campaign Builder</h1>
            <p class="text-gray-600 mt-2">Build campaigns, save your progress, and export for Google Ads Editor.</p>
        </header>

        <!-- Keyword Helper -->
        <div class="mb-6 bg-white p-4 rounded-lg shadow">
            <details>
                <summary class="cursor-pointer text-lg font-semibold text-gray-800">Keyword Match Type Helper</summary>
                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Paste Keywords (one per line)</label>
                        <textarea id="keyword-helper-input" class="form-textarea" rows="5"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Generated Keywords</label>
                        <textarea id="keyword-helper-output" class="form-textarea" rows="5" readonly></textarea>
                    </div>
                </div>
                <div class="mt-2 flex items-center space-x-4">
                    <button id="generate-keywords" class="btn-secondary">Generate</button>
                    <div class="flex items-center space-x-3 text-sm text-gray-700">
                        <span>Include:</span>
                        <label class="flex items-center"><input type="checkbox" id="kw-broad" class="form-checkbox" checked> <span class="ml-1">Broad</span></label>
                        <label class="flex items-center"><input type="checkbox" id="kw-phrase" class="form-checkbox" checked> <span class="ml-1">Phrase</span></label>
                        <label class="flex items-center"><input type="checkbox" id="kw-exact" class="form-checkbox" checked> <span class="ml-1">Exact</span></label>
                    </div>
                </div>
            </details>
        </div>

        <form id="multi-campaign-form">
            <div id="account-level-container">
                <div class="account-item">
                    <div class="input-group">
                        <h3 class="text-2xl font-semibold text-gray-800">Account Settings & Extensions</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                            <div>
                                <h4 class="text-lg font-semibold text-gray-700 mb-2">Client & Account Reference</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><input type="text" id="client-name" class="form-input" placeholder="Client Name"></div>
                                    <div><input type="text" id="client-cid" class="form-input" placeholder="Google Ads CID"></div>
                                    <div class="md:col-span-2"><input type="text" id="tracking-template" class="form-input" placeholder="Account Level Tracking Template"></div>
                                    <div class="md:col-span-2"><input type="text" id="url-suffix" class="form-input" placeholder="Account Level Final URL Suffix"></div>
                                </div>
                            </div>
                            <div>
                                <h4 class="text-lg font-semibold text-gray-700 mb-2">Save/Load Build</h4>
                                <div class="flex space-x-4">
                                    <button type="button" id="save-build" class="btn-secondary btn-accent flex-1">Save Build to File (.json)</button>
                                    <label for="load-build-input" class="btn-secondary btn-accent flex-1 text-center cursor-pointer">Load Build from File (.json)</label>
                                    <input type="file" id="load-build-input" class="hidden" accept=".json">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="input-group">
                        <details>
                            <summary><h3 class="text-xl font-semibold text-gray-700 inline">Account Level Extensions</h3></summary>
                            <div class="mt-4">
                                <details class="mb-4"><summary class="text-lg font-semibold text-gray-600">Call Extension</summary><div class="account-call-extension-container mt-2"></div><button type="button" class="add-ext mt-2 btn-secondary btn-sm" data-ext-type="call" data-ext-container=".account-call-extension-container" data-limit="1">+ Add Call Extension</button></details>
                                <details class="mb-4"><summary class="text-lg font-semibold text-gray-600">Callouts</summary><div class="account-callouts-container mt-2"></div><button type="button" class="add-ext mt-2 btn-secondary btn-sm" data-ext-type="callout" data-ext-container=".account-callouts-container">+ Add Callout</button></details>
                                <details class="mb-4"><summary class="text-lg font-semibold text-gray-600">Structured Snippets</summary><div class="account-snippets-container mt-2"></div><button type="button" class="add-ext mt-2 btn-secondary btn-sm" data-ext-type="snippet" data-ext-container=".account-snippets-container">+ Add Snippet</button></details>
                                <details class="mb-4"><summary class="text-lg font-semibold text-gray-600">Image Extensions</summary><div class="account-images-container mt-2"></div><button type="button" class="add-ext mt-2 btn-secondary btn-sm" data-ext-type="image" data-ext-container=".account-images-container">+ Add Image</button></details>
                                <details><summary class="text-lg font-semibold text-gray-600">Promotion Extensions</summary><div class="account-promotions-container mt-2"></div><button type="button" class="add-ext mt-2 btn-secondary btn-sm" data-ext-type="promotion" data-ext-container=".account-promotions-container">+ Add Promotion</button></details>
                            </div>
                        </details>
                    </div>
                </div>
            </div>

            <div id="campaigns-container"></div>
            <div class="text-center my-6">
                <button type="button" id="add-campaign" class="btn-secondary text-base font-bold py-3 px-6">+ Add Another Campaign</button>
            </div>
            <div class="text-center mt-8 p-4 bg-white rounded-lg shadow-md sticky bottom-4">
                <button type="submit" class="btn-primary text-xl w-full md:w-auto">Generate & Download CSV for Editor</button>
            </div>
        </form>
    </div>

    <!-- TEMPLATES START HERE -->
    <template id="campaign-template">
        <div class="campaign-item relative">
            <div class="absolute top-4 right-4 flex space-x-4">
                <button type="button" class="duplicate-campaign text-blue-500 hover:text-blue-700 flex items-center space-x-1 text-sm font-medium" title="Duplicate Campaign">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                    <span>Duplicate</span>
                </button>
                <button type="button" class="remove-campaign remove-btn flex items-center space-x-1 text-sm font-medium" title="Remove Campaign">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    <span>Remove</span>
                </button>
            </div>
            <div class="input-group">
                <div class="campaign-header flex justify-between items-center">
                    <h3 class="text-2xl font-semibold text-gray-800">Campaign Settings</h3>
                    <span class="text-gray-500 text-sm">[Click to Collapse/Expand]</span>
                </div>
                <div class="campaign-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">Campaign Name</label><input type="text" class="form-input campaign-name" placeholder="e.g., Winter Coats - USA" required></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">Daily Budget ($)</label><input type="number" class="form-input campaign-budget" placeholder="e.g., 100" min="1" required></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">Campaign Status</label><select class="form-select campaign-status"><option value="Paused" selected>Paused</option><option value="Enabled">Enabled</option></select></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">Bid Strategy Type</label><select class="form-select bid-strategy"><option value="Maximize Clicks" selected>Maximize Clicks</option><option value="Maximize Conversions">Maximize Conversions</option><option value="Manual CPC">Manual CPC</option><option value="Target CPA">Target CPA</option></select></div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Networks</label>
                            <div class="flex items-center space-x-4">
                                <label class="flex items-center"><input type="checkbox" class="form-checkbox search-partners"> <span class="ml-2">Include Google search partners</span></label>
                                <label class="flex items-center"><input type="checkbox" class="form-checkbox display-network"> <span class="ml-2">Include Google Display Network</span></label>
                            </div>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Location Targeting Option</label>
                            <select class="form-select location-option">
                                <option value="Presence or interest">Presence or interest</option>
                                <option value="Presence" selected>Presence</option>
                                <option value="Search interest">Search interest</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Location Targeting (one per line)</label>
                            <textarea class="form-textarea locations" rows="4" placeholder="California&#10;89117:US&#10;(10mi:34.0522:-118.2437)"></textarea>
                            <p class="text-xs text-gray-500 mt-1">Accepted formats: City/State/Country names, ZipCode:CountryCode, or (distance:lat:lon).</p>
                        </div>
                        <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-1">Ad Schedule (one per line)</label><textarea class="form-textarea ad-schedule" rows="3" placeholder="(Monday[09:00-17:00])&#10;(Tuesday[09:00-17:00])"></textarea><p class="text-xs text-gray-500 mt-1">Format: (Day[HH:MM-HH:MM]).</p></div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Campaign Negative Keywords (one per line)</label>
                            <textarea class="form-textarea campaign-negatives" rows="3" placeholder="[free]&#10;&quot;cheap&quot;&#10;jobs"></textarea>
                            <p class="text-xs text-gray-500 mt-1">Use [exact], "phrase", or broad for match types.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="campaign-content">
                <div class="input-group">
                    <details>
                        <summary><h3 class="text-xl font-semibold text-gray-700 inline">Campaign Level Extensions</h3></summary>
                        <div class="mt-4">
                            <details class="mb-4"><summary class="text-lg font-semibold text-gray-600">Sitelinks</summary><div class="campaign-sitelinks-container mt-2"></div><button type="button" class="add-ext mt-2 btn-secondary btn-sm" data-ext-type="sitelink" data-ext-container=".campaign-sitelinks-container" data-limit="10">+ Add Sitelink</button></details>
                            <details class="mb-4"><summary class="text-lg font-semibold text-gray-600">Call Extension</summary><div class="campaign-call-extension-container mt-2"></div><button type="button" class="add-ext mt-2 btn-secondary btn-sm" data-ext-type="call" data-ext-container=".campaign-call-extension-container" data-limit="1">+ Add Call Extension</button></details>
                            <details class="mb-4"><summary class="text-lg font-semibold text-gray-600">Callouts</summary><div class="campaign-callouts-container mt-2"></div><button type="button" class="add-ext mt-2 btn-secondary btn-sm" data-ext-type="callout" data-ext-container=".campaign-callouts-container">+ Add Callout</button></details>
                            <details class="mb-4"><summary class="text-lg font-semibold text-gray-600">Structured Snippets</summary><div class="campaign-snippets-container mt-2"></div><button type="button" class="add-ext mt-2 btn-secondary btn-sm" data-ext-type="snippet" data-ext-container=".campaign-snippets-container">+ Add Snippet</button></details>
                            <details class="mb-4"><summary class="text-lg font-semibold text-gray-600">Image Extensions</summary><div class="campaign-images-container mt-2"></div><button type="button" class="add-ext mt-2 btn-secondary btn-sm" data-ext-type="image" data-ext-container=".campaign-images-container">+ Add Image</button></details>
                            <details><summary class="text-lg font-semibold text-gray-600">Promotion Extensions</summary><div class="campaign-promotions-container mt-2"></div><button type="button" class="add-ext mt-2 btn-secondary btn-sm" data-ext-type="promotion" data-ext-container=".campaign-promotions-container">+ Add Promotion</button></details>
                        </div>
                    </details>
                </div>
                <div class="input-group">
                    <h3 class="text-xl font-semibold text-gray-700">Ad Groups, Keywords & Ads</h3>
                    <div class="ad-groups-container"></div>
                    <button type="button" class="add-ad-group mt-4 btn-secondary">+ Add Ad Group</button>
                </div>
            </div>
        </div>
    </template>
    <template id="ad-group-template">
        <div class="ad-group-item relative">
            <div class="absolute top-4 right-0 flex space-x-2">
                <button type="button" class="duplicate-ad-group text-blue-500 hover:text-blue-700 text-sm font-medium" title="Duplicate Ad Group">Duplicate</button>
                <button type="button" class="remove-ad-group remove-btn text-sm font-medium" title="Remove Ad Group">Remove</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="md:col-span-1">
                    <h4 class="text-lg font-semibold text-gray-600 mb-2">Ad Group & Keywords</h4>
                    <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-1">Ad Group Name</label><input type="text" class="form-input ad-group-name" placeholder="e.g., Wool Coats - Phrase" required></div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Keywords (one per line)</label>
                        <textarea class="form-textarea keywords" rows="10" placeholder="[wool coats for women]&#10;&quot;buy wool coats&quot;&#10;mens winter coats" required></textarea>
                        <p class="text-xs text-gray-500 mt-1">Use [exact], "phrase", or broad for match types.</p>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ad Group Negative Keywords</label>
                        <textarea class="form-textarea adgroup-negatives" rows="3" placeholder="[used]&#10;&quot;second hand&quot;"></textarea>
                        <p class="text-xs text-gray-500 mt-1">Use [exact], "phrase", or broad for match types.</p>
                    </div>
                </div>
                <div class="md:col-span-1">
                    <h4 class="text-lg font-semibold text-gray-600 mb-2">Responsive Search Ad</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Headlines (one per line, max 15)</label>
                            <textarea class="form-textarea rsa-headlines" data-limit="30" rows="8" placeholder="Up to 15 headlines..." required></textarea>
                            <div class="live-preview rsa-headlines-preview"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Descriptions (one per line, max 4)</label>
                            <textarea class="form-textarea rsa-descriptions" data-limit="90" rows="4" placeholder="Up to 4 descriptions..." required></textarea>
                            <div class="live-preview rsa-descriptions-preview"></div>
                        </div>
                        <input type="url" class="form-input final-url" placeholder="https://www.example.com" required>
                    </div>
                </div>
            </div>
            <div class="input-group mt-6">
                <details>
                    <summary><h3 class="text-xl font-semibold text-gray-700 inline">Ad Group Level Extensions</h3></summary>
                    <div class="mt-4">
                        <details class="mb-4"><summary class="text-lg font-semibold text-gray-600">Sitelinks</summary><div class="adgroup-sitelinks-container mt-2"></div><button type="button" class="add-ext mt-2 btn-secondary btn-sm" data-ext-type="sitelink" data-ext-container=".adgroup-sitelinks-container" data-limit="10">+ Add Sitelink</button></details>
                        <details class="mb-4"><summary class="text-lg font-semibold text-gray-600">Call Extension</summary><div class="adgroup-call-extension-container mt-2"></div><button type="button" class="add-ext mt-2 btn-secondary btn-sm" data-ext-type="call" data-ext-container=".adgroup-call-extension-container" data-limit="1">+ Add Call Extension</button></details>
                        <details class="mb-4"><summary class="text-lg font-semibold text-gray-600">Callouts</summary><div class="adgroup-callouts-container mt-2"></div><button type="button" class="add-ext mt-2 btn-secondary btn-sm" data-ext-type="callout" data-ext-container=".adgroup-callouts-container">+ Add Callout</button></details>
                        <details class="mb-4"><summary class="text-lg font-semibold text-gray-600">Structured Snippets</summary><div class="adgroup-snippets-container mt-2"></div><button type="button" class="add-ext mt-2 btn-secondary btn-sm" data-ext-type="snippet" data-ext-container=".adgroup-snippets-container">+ Add Snippet</button></details>
                        <details class="mb-4"><summary class="text-lg font-semibold text-gray-600">Image Extensions</summary><div class="adgroup-images-container mt-2"></div><button type="button" class="add-ext mt-2 btn-secondary btn-sm" data-ext-type="image" data-ext-container=".adgroup-images-container">+ Add Image</button></details>
                        <details><summary class="text-lg font-semibold text-gray-600">Promotion Extensions</summary><div class="adgroup-promotions-container mt-2"></div><button type="button" class="add-ext mt-2 btn-secondary btn-sm" data-ext-type="promotion" data-ext-container=".adgroup-promotions-container">+ Add Promotion</button></details>
                    </div>
                </details>
            </div>
        </div>
    </template>
    <!-- Extension Templates -->
    <template id="call-ext-template"><div class="extension-item relative"><button type="button" class="remove-ext absolute top-2 right-0 remove-btn">&times;</button><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium">Country</label><select class="form-select call-country"><option value="US">United States</option><option value="GB">United Kingdom</option><option value="CA">Canada</option><option value="AU">Australia</option><option value="DE">Germany</option><option value="FR">France</option><option value="ES">Spain</option><option value="MX">Mexico</option><option value="BR">Brazil</option><option value="IN">India</option></select></div><div><label class="block text-sm font-medium">Phone Number</label><input type="tel" class="form-input call-phone-number" placeholder="+12125551234" required></div></div></div></template>
    <template id="sitelink-ext-template"><div class="extension-item relative grid grid-cols-1 md:grid-cols-2 gap-4"><button type="button" class="remove-ext absolute top-2 right-0 remove-btn">&times;</button><div><label class="block text-sm font-medium">Sitelink Text</label><input type="text" class="form-input sitelink-text" placeholder="Shop Men's Coats" maxlength="25" required></div><div><label class="block text-sm font-medium">Final URL</label><input type="url" class="form-input sitelink-url" placeholder="https://example.com/mens" required></div><div class="md:col-span-2"><label class="block text-sm font-medium">Description 1 (optional)</label><input type="text" class="form-input sitelink-desc1" maxlength="35"></div><div class="md:col-span-2"><label class="block text-sm font-medium">Description 2 (optional)</label><input type="text" class="form-input sitelink-desc2" maxlength="35"></div></div></template>
    <template id="callout-ext-template"><div class="extension-item relative"><button type="button" class="remove-ext absolute top-2 right-0 remove-btn">&times;</button><label class="block text-sm font-medium">Callout Text</label><input type="text" class="form-input callout-text" placeholder="Free Shipping" maxlength="25" required></div></template>
    <template id="image-ext-template">
        <div class="extension-item relative">
            <button type="button" class="remove-ext absolute top-2 right-0 remove-btn">&times;</button>
            <div class="grid grid-cols-1 gap-4">
                <div>
                    <label class="block text-sm font-medium">Image Upload</label>
                    <div class="mt-1 drop-zone flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md cursor-pointer">
                        <div class="space-y-1 text-center image-drop-prompt">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <p class="text-sm text-gray-600">
                                <span class="font-medium text-indigo-600 hover:text-indigo-500">Upload a file</span> or drag and drop
                            </p>
                            <p class="text-xs text-gray-500">PNG, JPG, GIF</p>
                        </div>
                        <div class="image-preview-container hidden text-center">
                             <img class="image-preview max-h-32 mx-auto rounded-md" src="" alt="Image Preview">
                             <button type="button" class="clear-image-btn remove-btn text-xs mt-1">Remove Image</button>
                        </div>
                        <input type="file" class="image-file-input hidden" accept="image/png, image/jpeg, image/gif">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium">Or Image URL / Asset ID</label>
                    <input type="text" class="form-input image-asset" placeholder="https://example.com/image.jpg or 123456789">
                </div>
            </div>
        </div>
    </template>
    <template id="snippet-ext-template">
        <div class="extension-item relative">
            <button type="button" class="remove-ext absolute top-2 right-0 remove-btn">&times;</button>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium">Header</label>
                    <select class="form-select snippet-header"><option>Brands</option><option>Amenities</option><option>Courses</option><option>Destinations</option><option>Featured hotels</option><option>Insurance coverage</option><option>Models</option><option>Neighborhoods</option><option>Service catalog</option><option>Shows</option><option>Styles</option><option>Types</option></select>
                </div>
            </div>
            <div class="snippet-values-container space-y-2 mt-4">
                <div><label class="block text-sm font-medium">Value 1</label><input type="text" class="form-input snippet-value" placeholder="Value 1" required></div>
                <div><label class="block text-sm font-medium">Value 2</label><input type="text" class="form-input snippet-value" placeholder="Value 2" required></div>
                <div><label class="block text-sm font-medium">Value 3</label><input type="text" class="form-input snippet-value" placeholder="Value 3" required></div>
            </div>
            <button type="button" class="add-snippet-value mt-2 btn-secondary btn-sm">+ Add Value</button>
        </div>
    </template>
    <template id="promotion-ext-template"><div class="extension-item relative"><button type="button" class="remove-ext absolute top-2 right-0 remove-btn">&times;</button><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium">Item</label><input type="text" class="form-input promo-item" placeholder="Winter Coats" maxlength="20" required></div><div><label class="block text-sm font-medium">Final URL</label><input type="url" class="form-input promo-url" placeholder="https://example.com/sale" required></div><div><label class="block text-sm font-medium">Promotion Type</label><select class="form-select promo-type"><option>Monetary discount</option><option>Percent discount</option></select></div><div><label class="block text-sm font-medium">Value</label><input type="number" class="form-input promo-value" placeholder="20" required></div><div class="md:col-span-2"><label class="block text-sm font-medium">Occasion (optional)</label><select class="form-select promo-occasion"><option value="">None</option><option>New Year's</option><option>Valentine's Day</option><option>Easter</option><option>Mother's Day</option><option>Father's Day</option><option>Labor Day</option><option>Back To School</option><option>Halloween</option><option>Black Friday</option><option>Cyber Monday</option><option>Christmas</option></select></div></div></div></template>
    <!-- TEMPLATES END HERE -->

    <!-- Custom Modal -->
    <div id="custom-alert" class="modal-overlay">
        <div class="modal-content">
            <p id="custom-alert-message"></p>
            <button id="custom-alert-close" class="btn-primary modal-close-btn">OK</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- DOM Elements ---
        const campaignsContainer = document.getElementById('campaigns-container');
        const accountContainer = document.getElementById('account-level-container');
        const multiCampaignForm = document.getElementById('multi-campaign-form');
        const saveBtn = document.getElementById('save-build');
        const loadInput = document.getElementById('load-build-input');
        const addCampaignBtn = document.getElementById('add-campaign');
        const customAlert = document.getElementById('custom-alert');
        const customAlertMessage = document.getElementById('custom-alert-message');
        const customAlertClose = document.getElementById('custom-alert-close');

        const templates = {
            campaign: document.getElementById('campaign-template'),
            adGroup: document.getElementById('ad-group-template'),
            call: document.getElementById('call-ext-template'),
            sitelink: document.getElementById('sitelink-ext-template'),
            callout: document.getElementById('callout-ext-template'),
            snippet: document.getElementById('snippet-ext-template'),
            promotion: document.getElementById('promotion-ext-template'),
            image: document.getElementById('image-ext-template')
        };
        
        // --- Helper Functions ---
        const getInputValue = (element, selector) => element.querySelector(selector)?.value || '';
        const setInputValue = (element, selector, value) => { if(element.querySelector(selector)) element.querySelector(selector).value = value; };
        const getInputChecked = (element, selector) => element.querySelector(selector)?.checked || false;
        const setInputChecked = (element, selector, checked) => { if(element.querySelector(selector)) element.querySelector(selector).checked = checked; };
        const splitTextarea = (value) => value.trim().split('\n').filter(line => line.trim() !== '');
        
        const parseKeyword = (keywordLine) => {
            let keyword = keywordLine.trim();
            let matchType = 'Broad';
            if (keyword.startsWith('[') && keyword.endsWith(']')) {
                matchType = 'Exact';
                keyword = keyword.slice(1, -1).trim();
            } else if (keyword.startsWith('"') && keyword.endsWith('"')) {
                matchType = 'Phrase';
                keyword = keyword.slice(1, -1).trim();
            }
            return { keyword, matchType };
        };
        
        const escapeCsvField = (field) => {
            const str = String(field || '');
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return `"${str.replace(/"/g, '""')}"`;
            }
            return str;
        };

        const createCsvRow = (data, headers) => {
            return headers.map(header => escapeCsvField(data[header])).join(',');
        };

        const showAlert = (message) => {
            customAlertMessage.textContent = message;
            customAlert.classList.add('visible');
        };

        customAlertClose.addEventListener('click', () => {
            customAlert.classList.remove('visible');
        });

        // --- Core Functions ---
        const addExtension = (container, type, data = null) => {
            const clone = templates[type].content.cloneNode(true);
            const extElement = clone.querySelector('.extension-item');
            container.appendChild(clone);
            if (data) loadExtensionData(extElement, type, data);
            return extElement;
        };

        const addAdGroup = (adGroupsContainer, data = null) => {
            const clone = templates.adGroup.content.cloneNode(true);
            const adGroupItem = clone.querySelector('.ad-group-item');
            adGroupsContainer.appendChild(adGroupItem);
            if (data) loadSingleAdGroupData(adGroupItem, data);
            return adGroupItem;
        };

        const addCampaign = (data = null) => {
            const clone = templates.campaign.content.cloneNode(true);
            const campaignItem = clone.querySelector('.campaign-item');
            campaignsContainer.appendChild(campaignItem);
            
            if (data) {
                loadSingleCampaignData(campaignItem, data);
            } else {
                addAdGroup(campaignItem.querySelector('.ad-groups-container'));
            }
            return campaignItem;
        };

        const getExtensionsFromContainer = (container) => {
            const selectors = {
                call: '.account-call-extension-container, .campaign-call-extension-container, .adgroup-call-extension-container',
                callout: '.account-callouts-container, .campaign-callouts-container, .adgroup-callouts-container',
                snippet: '.account-snippets-container, .campaign-snippets-container, .adgroup-snippets-container',
                promotion: '.account-promotions-container, .campaign-promotions-container, .adgroup-promotions-container',
                image: '.account-images-container, .campaign-images-container, .adgroup-images-container',
                sitelink: '.campaign-sitelinks-container, .adgroup-sitelinks-container'
            };

            return {
                call: Array.from(container.querySelectorAll(`${selectors.call} .extension-item`)).map(el => ({ phone: getInputValue(el, '.call-phone-number'), country: getInputValue(el, '.call-country') })),
                callouts: Array.from(container.querySelectorAll(`${selectors.callout} .extension-item`)).map(el => ({ text: getInputValue(el, '.callout-text') })),
                snippets: Array.from(container.querySelectorAll(`${selectors.snippet} .extension-item`)).map(el => {
                    const values = Array.from(el.querySelectorAll('.snippet-value')).map(input => input.value.trim()).filter(v => v);
                    return { header: getInputValue(el, '.snippet-header'), values: values.join(';') }; // Use semicolon for editor compatibility
                }),
                promotions: Array.from(container.querySelectorAll(`${selectors.promotion} .extension-item`)).map(el => ({ item: getInputValue(el, '.promo-item'), url: getInputValue(el, '.promo-url'), type: getInputValue(el, '.promo-type'), value: getInputValue(el, '.promo-value'), occasion: getInputValue(el, '.promo-occasion') })),
                images: Array.from(container.querySelectorAll(`${selectors.image} .extension-item`)).map(el => ({ asset: getInputValue(el, '.image-asset') })),
                sitelinks: Array.from(container.querySelectorAll(`${selectors.sitelink} .extension-item`)).map(el => ({ text: getInputValue(el, '.sitelink-text'), url: getInputValue(el, '.sitelink-url'), desc1: getInputValue(el, '.sitelink-desc1'), desc2: getInputValue(el, '.sitelink-desc2') }))
            };
        };

        // --- Data Extraction (get... functions) ---
        const getSingleAdGroupData = (adGroupEl) => ({
            name: getInputValue(adGroupEl, '.ad-group-name'),
            keywords: getInputValue(adGroupEl, '.keywords'),
            finalUrl: getInputValue(adGroupEl, '.final-url'),
            adgroupNegatives: getInputValue(adGroupEl, '.adgroup-negatives'),
            headlines: getInputValue(adGroupEl, '.rsa-headlines'),
            descriptions: getInputValue(adGroupEl, '.rsa-descriptions'),
            extensions: getExtensionsFromContainer(adGroupEl)
        });

        const getSingleCampaignData = (campaignEl) => ({
            settings: {
                name: getInputValue(campaignEl, '.campaign-name'), budget: getInputValue(campaignEl, '.campaign-budget'),
                status: getInputValue(campaignEl, '.campaign-status'), bidStrategy: getInputValue(campaignEl, '.bid-strategy'),
                adSchedule: getInputValue(campaignEl, '.ad-schedule'), campaignNegatives: getInputValue(campaignEl, '.campaign-negatives'),
                searchPartners: getInputChecked(campaignEl, '.search-partners'), displayNetwork: getInputChecked(campaignEl, '.display-network'),
                locationOption: getInputValue(campaignEl, '.location-option'),
            },
            locations: getInputValue(campaignEl, '.locations'),
            extensions: getExtensionsFromContainer(campaignEl),
            adGroups: Array.from(campaignEl.querySelectorAll('.ad-group-item')).map(getSingleAdGroupData)
        });
        
        const getAccountData = () => ({
            clientName: document.getElementById('client-name').value,
            clientCid: document.getElementById('client-cid').value,
            trackingTemplate: document.getElementById('tracking-template').value,
            urlSuffix: document.getElementById('url-suffix').value,
            extensions: getExtensionsFromContainer(accountContainer)
        });

        // --- Data Loading (load... functions) ---
        const loadExtensions = (container, extensions) => {
            if (!extensions) return;
            const extMap = {
                call: '.account-call-extension-container, .campaign-call-extension-container, .adgroup-call-extension-container',
                callout: '.account-callouts-container, .campaign-callouts-container, .adgroup-callouts-container',
                snippet: '.account-snippets-container, .campaign-snippets-container, .adgroup-snippets-container',
                promotion: '.account-promotions-container, .campaign-promotions-container, .adgroup-promotions-container',
                image: '.account-images-container, .campaign-images-container, .adgroup-images-container',
                sitelink: '.campaign-sitelinks-container, .adgroup-sitelinks-container'
            };

            Object.entries(extensions).forEach(([type, dataArray]) => {
                if(dataArray && dataArray.length > 0 && extMap[type]){
                    const targetContainer = container.querySelector(extMap[type]);
                    if(targetContainer) {
                        dataArray.forEach(data => addExtension(targetContainer, type, data));
                    }
                }
            });
        };

        const loadExtensionData = (el, type, data) => {
            switch(type) {
                case 'call': setInputValue(el, '.call-phone-number', data.phone); setInputValue(el, '.call-country', data.country); break;
                case 'sitelink': setInputValue(el, '.sitelink-text', data.text); setInputValue(el, '.sitelink-url', data.url); setInputValue(el, '.sitelink-desc1', data.desc1); setInputValue(el, '.sitelink-desc2', data.desc2); break;
                case 'callout': setInputValue(el, '.callout-text', data.text); break;
                case 'snippet':
                    setInputValue(el, '.snippet-header', data.header);
                    const values = data.values.includes(';') ? data.values.split(';') : data.values.split('\n');
                    const valueContainer = el.querySelector('.snippet-values-container');
                    valueContainer.innerHTML = ''; // Clear existing before loading
                    values.forEach((value) => {
                        addSnippetValue(valueContainer, value.trim());
                    });
                    break;
                case 'promotion': setInputValue(el, '.promo-item', data.item); setInputValue(el, '.promo-url', data.url); setInputValue(el, '.promo-type', data.type); setInputValue(el, '.promo-value', data.value); setInputValue(el, '.promo-occasion', data.occasion); break;
                case 'image': 
                    const assetInput = el.querySelector('.image-asset');
                    const dropZone = el.querySelector('.drop-zone');
                    assetInput.value = data.asset || '';
                    if (data.asset && data.asset.startsWith('data:image')) {
                        updateImagePreview(dropZone, data.asset);
                    }
                    break;
            }
        };

        const loadSingleAdGroupData = (adGroupEl, adGroupData) => {
            setInputValue(adGroupEl, '.ad-group-name', adGroupData.name);
            setInputValue(adGroupEl, '.keywords', adGroupData.keywords);
            setInputValue(adGroupEl, '.final-url', adGroupData.finalUrl);
            setInputValue(adGroupEl, '.adgroup-negatives', adGroupData.adgroupNegatives);
            setInputValue(adGroupEl, '.rsa-headlines', adGroupData.headlines);
            setInputValue(adGroupEl, '.rsa-descriptions', adGroupData.descriptions);
            loadExtensions(adGroupEl, adGroupData.extensions);
            // Trigger validation after loading
            adGroupEl.querySelectorAll('.rsa-headlines, .rsa-descriptions').forEach(validateAdCopy);
        };

        const loadSingleCampaignData = (campaignEl, campaignData) => {
            const { settings, locations, adGroups, extensions } = campaignData;
            setInputValue(campaignEl, '.campaign-name', settings.name);
            setInputValue(campaignEl, '.campaign-budget', settings.budget);
            setInputValue(campaignEl, '.campaign-status', settings.status);
            setInputValue(campaignEl, '.bid-strategy', settings.bidStrategy);
            setInputValue(campaignEl, '.ad-schedule', settings.adSchedule);
            setInputValue(campaignEl, '.campaign-negatives', settings.campaignNegatives);
            setInputChecked(campaignEl, '.search-partners', settings.searchPartners);
            setInputChecked(campaignEl, '.display-network', settings.displayNetwork);
            setInputValue(campaignEl, '.location-option', settings.locationOption || 'Presence');
            setInputValue(campaignEl, '.locations', locations || '');
            
            const adGroupsContainer = campaignEl.querySelector('.ad-groups-container');
            adGroupsContainer.innerHTML = '';
            adGroups?.forEach(data => addAdGroup(adGroupsContainer, data));
            
            loadExtensions(campaignEl, extensions);
        };
        
        const addSnippetValue = (container, value = '') => {
            const count = container.children.length;
            if (count >= 10) return;
            const div = document.createElement('div');
            const required = count < 3 ? 'required' : '';
            div.innerHTML = `<label class="block text-sm font-medium">Value ${count + 1}</label><input type="text" class="form-input snippet-value" placeholder="Value ${count + 1}" value="${escapeHtml(value)}" ${required}>`;
            container.appendChild(div);
        };

        // --- Event Delegation & Input Handling ---
        document.body.addEventListener('click', (e) => {
            const target = e.target;
            const campaignItem = target.closest('.campaign-item');
            const adGroupItem = target.closest('.ad-group-item');

            if (target.closest('.add-snippet-value')) {
                const container = target.previousElementSibling;
                addSnippetValue(container);
            }
            if (target.closest('.remove-campaign')) {
                if (campaignsContainer.children.length > 1) campaignItem.remove();
                else showAlert("You must have at least one campaign.");
            }
            if (target.closest('.duplicate-campaign')) {
                const newCampaign = addCampaign(getSingleCampaignData(campaignItem));
                newCampaign.querySelector('.campaign-name').value += " (Copy)";
            }
            if (target.closest('.campaign-header')) {
                campaignItem.querySelectorAll('.campaign-content').forEach(el => el.classList.toggle('hidden'));
            }
            if (target.closest('.add-ad-group')) {
                addAdGroup(campaignItem.querySelector('.ad-groups-container'));
            }
            if (target.closest('.add-ext')) {
                const btn = target.closest('.add-ext');
                const container = target.closest('.account-item, .campaign-item, .ad-group-item').querySelector(btn.dataset.extContainer);
                const limit = parseInt(btn.dataset.limit, 10);
                if (!limit || container.children.length < limit) {
                    addExtension(container, btn.dataset.extType);
                } else {
                    showAlert(`Only ${limit} of this extension type is allowed.`);
                }
            }
            if (target.closest('.remove-ad-group')) {
                const container = adGroupItem.parentElement;
                if (container.children.length > 1) adGroupItem.remove();
                else showAlert("You must have at least one ad group.");
            }
            if (target.closest('.duplicate-ad-group')) {
                const container = adGroupItem.parentElement;
                const newAdGroup = addAdGroup(container, getSingleAdGroupData(adGroupItem));
                newAdGroup.querySelector('.ad-group-name').value += " (Copy)";
            }
            if (target.closest('.remove-ext')) {
                target.closest('.extension-item').remove();
            }
            // Image upload handlers
            if (target.closest('.drop-zone')) {
                target.closest('.drop-zone').querySelector('.image-file-input').click();
            }
            if (target.closest('.clear-image-btn')) {
                clearImagePreview(target.closest('.drop-zone'));
            }
        });
        
        const validateAdCopy = (textarea) => {
            const limit = parseInt(textarea.dataset.limit, 10);
            const preview = textarea.parentElement.querySelector('.live-preview');
            const lines = textarea.value.split('\n');
            const html = lines.map(line => {
                const length = line.length;
                const count = `<span class="text-gray-500 ml-2">(${length}/${limit})</span>`;
                if (length > limit) {
                    return `<div class="char-limit-error">${escapeHtml(line)}${count}</div>`;
                }
                return `<div>${escapeHtml(line)}${count}</div>`;
            }).join('');
            preview.innerHTML = html;
        };

        const escapeHtml = (str) => str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");

        document.body.addEventListener('input', (e) => {
            if (e.target.matches('.rsa-headlines, .rsa-descriptions')) {
                validateAdCopy(e.target);
            }
            // Handle manual input in image asset field
            if (e.target.matches('.image-asset')) {
                const dropZone = e.target.closest('.extension-item').querySelector('.drop-zone');
                if (e.target.value && e.target.value.startsWith('data:image')) {
                    updateImagePreview(dropZone, e.target.value);
                } else if (!e.target.value) {
                    clearImagePreview(dropZone);
                }
            }
        });
        
        // --- Keyword Helper ---
        document.getElementById('generate-keywords').addEventListener('click', () => {
            const input = document.getElementById('keyword-helper-input');
            const output = document.getElementById('keyword-helper-output');
            const keywords = splitTextarea(input.value);
            
            const includeBroad = document.getElementById('kw-broad').checked;
            const includePhrase = document.getElementById('kw-phrase').checked;
            const includeExact = document.getElementById('kw-exact').checked;

            const variations = keywords.flatMap(kw => {
                const generated = [];
                if (includeBroad) generated.push(kw);
                if (includePhrase) generated.push(`"${kw}"`);
                if (includeExact) generated.push(`[${kw}]`);
                return generated;
            }).join('\n');
            
            output.value = variations;
        });

        // --- Image Upload & Drag/Drop ---
        const handleImageFile = (file, dropZone) => {
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = () => {
                    const dataURL = reader.result;
                    const assetInput = dropZone.closest('.extension-item').querySelector('.image-asset');
                    assetInput.value = dataURL;
                    updateImagePreview(dropZone, dataURL);
                };
                reader.readAsDataURL(file);
            } else {
                showAlert('Please select a valid image file (PNG, JPG, GIF).');
            }
        };

        const updateImagePreview = (dropZone, src) => {
            const previewContainer = dropZone.querySelector('.image-preview-container');
            const previewImg = dropZone.querySelector('.image-preview');
            const prompt = dropZone.querySelector('.image-drop-prompt');
            
            previewImg.src = src;
            prompt.classList.add('hidden');
            previewContainer.classList.remove('hidden');
        };

        const clearImagePreview = (dropZone) => {
            const previewContainer = dropZone.querySelector('.image-preview-container');
            const previewImg = dropZone.querySelector('.image-preview');
            const prompt = dropZone.querySelector('.image-drop-prompt');
            const assetInput = dropZone.closest('.extension-item').querySelector('.image-asset');

            previewImg.src = '';
            assetInput.value = '';
            prompt.classList.remove('hidden');
            previewContainer.classList.add('hidden');
        };

        document.body.addEventListener('change', e => {
            if (e.target.matches('.image-file-input')) {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    const dropZone = e.target.closest('.drop-zone');
                    handleImageFile(file, dropZone);
                }
            }
        });

        document.body.addEventListener('dragover', e => {
            const dropZone = e.target.closest('.drop-zone');
            if (dropZone) {
                e.preventDefault();
                dropZone.classList.add('drop-zone--over');
            }
        });

        ['dragleave', 'dragend'].forEach(type => {
            document.body.addEventListener(type, e => {
                const dropZone = e.target.closest('.drop-zone');
                if (dropZone) {
                    dropZone.classList.remove('drop-zone--over');
                }
            });
        });

        document.body.addEventListener('drop', e => {
            const dropZone = e.target.closest('.drop-zone');
            if (dropZone) {
                e.preventDefault();
                dropZone.classList.remove('drop-zone--over');
                if (e.dataTransfer.files.length > 0) {
                    const file = e.dataTransfer.files[0];
                    handleImageFile(file, dropZone);
                }
            }
        });


        // --- Save / Load / Autosave ---
        const AUTOSAVE_KEY = 'rynoCampaignBuilderAutosave';

        const autoSaveBuild = () => {
            try {
                const data = {
                    account: getAccountData(),
                    campaigns: Array.from(document.querySelectorAll('.campaign-item')).map(getSingleCampaignData)
                };
                localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(data));
            } catch (error) {
                console.error("Autosave failed:", error);
                if (error.name === 'QuotaExceededError') {
                    showAlert("Autosave failed: Local storage is full. This can happen if you upload large images. Please save your build to a file.");
                }
            }
        };
        
        let saveTimeout;
        document.body.addEventListener('input', () => {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(autoSaveBuild, 2000); 
        });


        const loadBuildData = (data) => {
            try {
                // Clear existing content
                campaignsContainer.innerHTML = '';
                document.querySelectorAll('.account-item .extension-item').forEach(el => el.remove());

                const accountData = data.account || data; // For backward compatibility
                document.getElementById('client-name').value = accountData.clientName || '';
                document.getElementById('client-cid').value = accountData.clientCid || '';
                document.getElementById('tracking-template').value = accountData.trackingTemplate || '';
                document.getElementById('url-suffix').value = accountData.urlSuffix || '';
                loadExtensions(accountContainer, accountData.extensions);

                if (data.campaigns && data.campaigns.length > 0) {
                    data.campaigns.forEach(campaignData => addCampaign(campaignData));
                } else {
                    addCampaign();
                }
            } catch (error) {
                showAlert('Error reading or parsing the JSON file.');
                console.error(error);
            }
        };

        saveBtn.addEventListener('click', () => {
            autoSaveBuild(); // Ensure latest data is saved before download
            const dataStr = localStorage.getItem(AUTOSAVE_KEY);
            if (!dataStr) {
                showAlert("No data to save.");
                return;
            }
            const data = JSON.parse(dataStr);
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            const clientName = (data.account.clientName || 'campaign_build').trim().replace(/[^a-z0-9]/gi, '_').toLowerCase();
            link.download = `${clientName}.json`;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
        });

        loadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    loadBuildData(data);
                } catch (err) {
                    showAlert("Invalid JSON file.");
                    console.error("JSON Parsing Error:", err);
                }
            };
            reader.onerror = () => {
                showAlert("Failed to read the file.");
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset input for re-upload
        });

        // --- Form Submission & CSV Generation ---
        multiCampaignForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const csvRows = [];
            const headers = [
                'Campaign', 'Campaign status', 'Budget', 'Campaign Type', 'Networks', 'Bid Strategy Type', 'Ad Group', 'Ad group status',
                'Keyword', 'Match type', 'Criterion Type', 'Final URL', 'Ad type', 'Ad status',
                'Headline 1', 'Headline 2', 'Headline 3', 'Headline 4', 'Headline 5', 'Headline 6', 'Headline 7', 'Headline 8', 'Headline 9', 'Headline 10', 'Headline 11', 'Headline 12', 'Headline 13', 'Headline 14', 'Headline 15',
                'Description 1', 'Description 2', 'Description 3', 'Description 4',
                'Link Text', 'Description Line 1', 'Description Line 2',
                'Header', 'Snippet Values', 'Callout text', 'Phone Number', 'Country of Phone',
                'Promotion item', 'Promotion final URL', 'Promotion type', 'Promotion value', 'Promotion occasion',
                'Image', 'Location', 'Ad schedule'
            ];
            csvRows.push(headers.join(','));

            const processExtensions = (extensions, levelData) => {
                if (!extensions) return;
                extensions.callouts?.forEach(ext => csvRows.push(createCsvRow({ ...levelData, 'Callout text': ext.text }, headers)));
                extensions.snippets?.forEach(ext => csvRows.push(createCsvRow({ ...levelData, 'Header': ext.header, 'Snippet Values': ext.values }, headers)));
                extensions.call?.forEach(ext => csvRows.push(createCsvRow({ ...levelData, 'Phone Number': ext.phone, 'Country of Phone': ext.country }, headers)));
                extensions.images?.forEach(ext => {
                    // Don't export the base64 string to the CSV, as Editor won't use it.
                    // The user must upload to the asset library and use the ID.
                    // We can leave the column blank or add a placeholder.
                    const assetValue = ext.asset.startsWith('data:image') ? '[Image Uploaded in Builder]' : ext.asset;
                    csvRows.push(createCsvRow({ ...levelData, 'Image': assetValue }, headers))
                });
                extensions.promotions?.forEach(ext => csvRows.push(createCsvRow({ ...levelData, 'Promotion item': ext.item, 'Promotion final URL': ext.url, 'Promotion type': ext.type, 'Promotion value': ext.value, 'Promotion occasion': ext.occasion }, headers)));
                extensions.sitelinks?.forEach(ext => csvRows.push(createCsvRow({ ...levelData, 'Link Text': ext.text, 'Final URL': ext.url, 'Description Line 1': ext.desc1, 'Description Line 2': ext.desc2 }, headers)));
            };
            
            autoSaveBuild(); // Save latest changes before exporting
            const fullDataStr = localStorage.getItem(AUTOSAVE_KEY);
            if (!fullDataStr) {
                showAlert("No data to export.");
                return;
            }
            const fullData = JSON.parse(fullDataStr);

            // Account Level Extensions
            processExtensions(fullData.account.extensions, {});

            // Campaigns
            fullData.campaigns.forEach(campaignData => {
                const campaignName = campaignData.settings.name;
                const campaignLevelData = { 'Campaign': campaignName };
                const networks = ['Google search'];
                if (campaignData.settings.searchPartners) networks.push('Search partners');
                if (campaignData.settings.displayNetwork) networks.push('Display');
                
                const campaignRow = {
                    ...campaignLevelData, 'Campaign status': campaignData.settings.status,
                    'Budget': campaignData.settings.budget, 'Campaign Type': 'Search',
                    'Networks': networks.join(';'), 'Bid Strategy Type': campaignData.settings.bidStrategy,
                };
                csvRows.push(createCsvRow(campaignRow, headers));

                splitTextarea(campaignData.locations).forEach(loc => csvRows.push(createCsvRow({ ...campaignLevelData, 'Location': loc }, headers)));
                splitTextarea(campaignData.settings.adSchedule).forEach(sch => csvRows.push(createCsvRow({ ...campaignLevelData, 'Ad schedule': sch }, headers)));
                splitTextarea(campaignData.settings.campaignNegatives).forEach(kw => {
                    const { keyword, matchType } = parseKeyword(kw);
                    csvRows.push(createCsvRow({ ...campaignLevelData, 'Keyword': keyword, 'Match type': matchType, 'Criterion Type': 'Negative' }, headers));
                });

                processExtensions(campaignData.extensions, campaignLevelData);

                // Ad Groups
                campaignData.adGroups.forEach(adGroupData => {
                    const adGroupName = adGroupData.name;
                    const adGroupLevelData = { ...campaignLevelData, 'Ad Group': adGroupName };
                    
                    const adRow = {
                        ...adGroupLevelData, 'Ad group status': 'Paused',
                        'Final URL': adGroupData.finalUrl, 'Ad type': 'Responsive search ad', 'Ad status': 'Paused'
                    };
                    splitTextarea(adGroupData.headlines).slice(0, 15).forEach((h, i) => adRow[`Headline ${i + 1}`] = h);
                    splitTextarea(adGroupData.descriptions).slice(0, 4).forEach((d, i) => adRow[`Description ${i + 1}`] = d);
                    csvRows.push(createCsvRow(adRow, headers));

                    splitTextarea(adGroupData.keywords).forEach(kw => {
                        const { keyword, matchType } = parseKeyword(kw);
                        csvRows.push(createCsvRow({ ...adGroupLevelData, 'Keyword': keyword, 'Match type': matchType, 'Criterion Type': 'Keyword' }, headers));
                    });
                    
                    splitTextarea(adGroupData.adgroupNegatives).forEach(kw => {
                        const { keyword, matchType } = parseKeyword(kw);
                        csvRows.push(createCsvRow({ ...campaignLevelData, 'Keyword': keyword, 'Match type': matchType, 'Criterion Type': 'Negative' }, headers));
                    });
                    
                    processExtensions(adGroupData.extensions, adGroupLevelData);
                });
            });

            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            const clientName = (fullData.account.clientName || 'campaign').trim().replace(/[^a-z0-9]/gi, '_').toLowerCase();
            link.setAttribute("href", url);
            link.setAttribute("download", `google_ads_${clientName}_upload.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
        // --- Initialize ---
        const savedSession = localStorage.getItem(AUTOSAVE_KEY);
        if (savedSession) {
            loadBuildData(JSON.parse(savedSession));
        } else {
            addCampaign();
        }
    });
    </script>
</body>
</html>

